# 操作说明



## 一、环境部署

### 

### 1.  UE4 插件安装

- Enhanced Vehicle Movement
- TCP Socket Plugin
- JSON Blueprint support
- Missile M26 (West)
- Editor Scripting Utilities
- Python Editor Script Plugin

### 2. UE4 环境准备

> - 红色箭头 x 指向地图的北，绿色箭头 y 指向地图的东，蓝色箭头默认指向上。
> - 将 UE4 静态环境的（0,0,0）点坐标对应的 WGS84 GPS 坐标写入 `gps.conf` 配置文件。
> - 安装好 UE4 Python 插件后，找到插件 Python 的安装目录，安装响应的库包如下：
>
> ```powershell
> $ cd C:\Program Files\Epic Games\UE_4.27\Engine\Binaries\ThirdParty\Python3\Win64
> $ python.exe -m pip install unreal pymongo pyyaml pymap3d requests folium
> ```
>
> - 将 `setup.py` 加入项目设置中 python 的启动位置，同时将文件所在路径也加入 Python 路径。

### 3. UE4 文件拷贝
> 将 `4_工程项目\mul_control_v0.3.3\Content\ `下的 `VigilanteContent、MYmoxing`、`Deaths`、、`Missle_related`、`Meshes`、`Modular_soldier_01`、`ThirdPersonBP`、`USParatrooper`、`Mannequin`、`Game_BP`、`start.uasset`、`TcpSocket_exp.uasset` 、`TcpSocket_exp1.uasset`、`TcpSocket_exp2.uasset` 、`TcpSocket_exp3.uasset` 、`TcpSocket_exp4.uasset` 到`自己的工程\Content\`下，注意不要覆盖自己已有的重要文件，其实 `mul_control_v0.3.3` 本身就是一个支持 AirSim 的实验测试工程。

### 4. MongoDB数据库的安装与配置

> 请参考文档 `1_MongoDB的安装与部署方法.md`

### 5. Python 安装包

> 进入相应的 Python 虚拟环境，安装 Python 包

```powershell
pip install numpy flask flask_cors gevent joblib pymongo loguru pymap3d folium pandas
```



## 二、UE4 操作准备



### 1. 启动 UE 工程

> 打开启动自己的 UE4 工程，支持 AirSim 模式。

### 2. 开启初始通讯

> 打开自己的 UE4 工程，在内容浏览器里，将 `Content\` 下的 `start` 和 `ChangeCam` 拖入视窗场景中的任意位置即可。例如`start` 蓝图包含了初始化坦克编号、名称、通讯方式、获取原点坐标等操作，坦克 `ip` 的 `port` 从 20000 开始根据对应的 `id` 自动分配端口，例如 `id` 为 0 的坦克的端口是 20000，`id` 为 1 的坦克的端口是 20001，而当前 `ip` 默认是本机 IP，即 127.0.0.1。而导弹的端口从30000开始，士兵的端口从40000开始，特朗普等换脸角色从50000开始。

### 3. 创建坦克群

> 在内容浏览器里，先在 `放置actor` 中搜索添加一个 `NavMeshBoundsVolume` 到视窗，把它放大到包含所有可以到达的地方就可以了。然后，进入 `Content\VigilanteContent\Vehicles\West_Tank_M1A1Abrams\`，拖动 `TK_AI` 蓝图进入视窗场景中，调整坦克位置即可，需要多个坦克，可以重复拖动 `TK_AI` 蓝图进入视窗场景，例如第一次拖动 `TK_AI`，生成名称为 `TK_AI` 的坦克，第二次则生成名为 `TK_AI2` 的坦克。`TK_AI` 蓝图包含了坦克数据存储与运动控制模块，同时也包含了单体TCP通讯模块。

### 4. 创建导弹群

> 在内容浏览器里，进入 `\Content\Missle_related\`，拖动 `MIS_AI` 蓝图进入视窗场景中，调整导弹位置，可直立住即可，需要多个导弹，可以重复拖动 `MIS_AI` 蓝图进入视窗场景，例如第一次拖动 `MIS_AI`，生成名称为 `MIS_AI` 的导弹，第二次则生成名为 `MIS_AI2` 的导弹。 `MIS_AI` 蓝图包含了导弹数据存储与运动控制模块，同时也包含了单体TCP通讯模块。

### 5. 创建士兵群

> 在内容浏览器里，进入 `\Content\Modular_soldier_01\新角色_士兵\`，拖动 `SOL_AI` 蓝图进入视窗场景中即可，可以重复拖动 `SOL_AI` 蓝图进入视窗场景，例如第一次拖动 `SOL_AI`，生成名称为 `SOL_AI` 的士兵，第二次则生成名为 `SOL_AI2` 的士兵。点击`SOL_AI` ，在细节中，找到动画类，选择 `SK modular Soldier Skeleton Anim Blueprint `  类。 `SOL_AI` 蓝图包含了士兵数据存储与运动控制模块，同时也包含了单体TCP通讯模块。

### 6. 创建特朗普

> 在内容浏览器里，进入 `\Content\Modular_soldier_01\新角色_士兵\chuanp\`，拖动 `TP_AI` 蓝图进入视窗场景中即可，可以重复拖动 `TP_AI` 蓝图进入视窗场景，例如第一次拖动 `TP_AI`，生成名称为 `TP_AI` 的特朗普。点击`TP_AI` ，在细节中，找到动画类，选择 `trup1_Skeleton_AnimBlueprint_C`  类。 `TP_AI` 蓝图包含了特朗普数据存储与运动控制模块，同时也包含了单体TCP通讯模块。

### 7. 创建拦截弹

> 在内容浏览器里，进入 `\Content\Missle_related\`，拖动 `MD_AI` 蓝图进入视窗场景中，调整拦截弹位置，可直立住即可，需要多个拦截弹，可以重复拖动 `MD_AI` 蓝图进入视窗场景，例如第一次拖动 `MD_AI`，生成名称为 `MD_AI` 的导弹，第二次则生成名为 `MD_AI2` 的导弹。 `MD_AI` 蓝图包含了拦截弹数据存储与运动控制模块，同时也包含了单体TCP通讯模块。。



## 三、python 操作



### 1. 进入程序根目录 

```powershell
cd MCI_v0.3.3
```

### 2. 运行多体控制接口程序

```powershell
python 1_UE_Main_API.py
```

### 3. 运行测试程序
```powershell
python 2_send_test_tank.py # 坦克控制测试案例 
python 2_send_test_missile.py # 导弹控制测试案例
python 2_send_test_solider.py # 士兵控制测试案例
python 2_send_test_trump.py # 特朗普控制测试案例
python 2_send_test_md.py # 拦截弹控制测试案例
python 2_send_test_cam.py # 摄像头切换控制测试案例
```

### 4. 运行 UE4 工程

> 点击 UE4 运行按钮，运行 AirSim 环境

### 5. 读取 MongoDB 数据库数据

```powershell
python 3_read_mongodb.py # 此为参考例子，需提前修改要读取的数据库与相关数据内容
```



## *、其它说明

> 1. 根目录下的 \*_info_dict.pkl 文件是接口服务生成的临时文件，不需要关注，未来将考虑直接从数据库读取。
> 2. 根目录下的 runtime.log 是接口服务运行过程中生成的日志文件，方便查看程序运行的错误日志。
> 3. 根目录下的 geo_change.py 是各种坐标或坐标系转换的函数库文件，也包括高德导航路径规划算法。
> 4. 根目录下的 TCPSOCKET.py 是实现 TCP Socket 通讯的核心文件，一般被 1_UE_Main_API.py 调用。
> 5. 根目录下的 setup.py 是 UE 静态 Actors 信息自动化获取程序，每次启动 UE4 时，会自动将信息放到 MongoDB 数据库 UE_Static_Actors 表中，每次信息的 Collection 用不同的时间字段表示出来。
> 6. 根目录下的 gps.conf 是 UE 静态原点的 GPS 配置文件。
> 7. 根目录下的 delet_db_collection.py 用于删除多余的 collection，仅供选用。